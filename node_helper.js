/*! *****************************************************************************
  mmm-rnv
  Version 1.2.0

  This is a departure monitor for the Rhein-Neckar-Verkehr (RNV) public transport network for the MagicMirrorÂ² platform.
  Please submit bugs at https://github.com/jalibu/MMM-RNV/issues

  (c) Julian Dinter,Jan Litzenburger
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */
"use strict";var e=require("node_helper"),t=require("logger");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var r=n(e),s=n(t);module.exports=r.create({start(){this.accessToken=null,this.schedule=[],this.colorCodesMap=new Map,this.failedRequests=0,this.getColorCodes()},async getColorCodes(){try{const e=await fetch("https://rnvopendataportalpublic.blob.core.windows.net/public/openDataPortal/liniengruppen-farben.json"),t=await e.json();this.colorCodesMap=new Map(t.lineGroups.map(e=>[e.id,e]))}catch(e){const t=e instanceof Error?e.message:String(e);s.warn(`Could not request color codes: ${t}`)}},async socketNotificationReceived(e,t){if("RNV_DEPARTURE_REQUEST"===e){const e=t;this.getData(e)}},async getData(e){try{if(!this.accessToken)try{this.accessToken=await this.createAccessToken(e)}catch(e){const t=e instanceof Error?e.message:String(e);return(s.error??s.warn)(`Error generating the client: ${t}`),void this.sendSocketNotification("RNV_ERROR_RESPONSE",{type:"WARNING",message:"Error with API authentication."})}const t=new Date(Date.now()+e.walkingTimeMs);s.info(`Request departures for station '${e.stationId}'`);const n="query GetDepartures($stationId: String!, $startTime: String!) {\n            station(id: $stationId) {\n                hafasID\n                longName\n                journeys(startTime: $startTime, first: 50) {\n                    totalCount\n                    elements {\n                        ... on Journey {\n                            line {\n                                id\n                            }\n                            type\n                            stops(onlyHafasID: $stationId) {\n                                pole {\n                                    platform {\n                                        type\n                                        label\n                                        barrierFreeType\n                                    }\n                                }\n                                destinationLabel\n                                plannedArrival {\n                                    isoString\n                                }\n                                realtimeArrival {\n                                    isoString\n                                }\n                                plannedDeparture {\n                                    isoString\n                                }\n                                realtimeDeparture {\n                                    isoString\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }",r=[],o=(await this.fetchGraphql(e.clientApiUrl,n,this.accessToken,{stationId:e.stationId,startTime:t.toISOString()})).data.station.journeys.elements.filter(e=>null!==e.stops[0].plannedDeparture.isoString);o.sort((e,t)=>{const n=e.stops[0].plannedDeparture.isoString,r=t.stops[0].plannedDeparture.isoString;return n&&r?n<r?-1:n>r?1:0:0});for(const t of o){const n=t.stops?.[0];if(!n?.plannedDeparture?.isoString)continue;const o=new Date(n.plannedDeparture.isoString);let a=0;try{const e=n.realtimeDeparture?.isoString;if(!e)throw new Error("Missing realtime departure");const t=new Date(e).getTime()-o.getTime();a=Math.round(t/6e4)}catch(e){const t=e instanceof Error?e.message:String(e);s.warn(`Error calculating the delay: ${t}`)}const i=t.line.id.split("-")[1];if(e.excludeLines.includes(i)||e.excludePlatforms.includes(n.pole.platform.label))continue;const c={line:i,destination:n.destinationLabel,departure:o.getTime(),delayInMin:a,platform:n.pole.platform.label,type:t.type,highlighted:e.highlightLines.includes(i),color:this.colorCodesMap.get(i)};if(r.push(c),r.length===e.maxResults)break}this.failedRequests=0,this.sendSocketNotification(`RNV_DATA_RESPONSE_${e.stationId}`,r)}catch(e){const t=e instanceof Error?e.message:String(e);s.warn(`Error fetching the data from the API: ${t}`),this.failedRequests+=1,this.failedRequests>5&&(this.accessToken=null,s.log("Reset the RNV API access token"),this.sendSocketNotification("RNV_ERROR_RESPONSE",{type:"WARNING",message:"Error fetching data."}))}},async createAccessToken(e){const{clientId:t,clientSecret:n,resourceId:r,tenantId:o}=e.credentials,a=await fetch(`https://login.microsoftonline.com/${o}/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`grant_type=client_credentials&client_id=${t}&client_secret=${n}&resource=${r}`});if(!a.ok)throw Error(`Could not fetch the access token (${a.status} ${a.statusText})`);const{access_token:i}=await a.json();return s.log("Created new RNV API access token"),i},async fetchGraphql(e,t,n,r){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",authorization:n?`Bearer ${n}`:""},body:JSON.stringify({query:t,variables:r})});if(!s.ok)throw Error(`GraphQL request failed (${s.status} ${s.statusText})`);const o=await s.json();if(o.errors?.length)throw Error(o.errors.map(e=>e.message).join("; "));return o}});
