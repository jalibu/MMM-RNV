/*! *****************************************************************************
  mmm-rnv
  Version 1.2.0

  This is a departure monitor for the Rhein-Neckar-Verkehr (RNV) public transport network for the MagicMirrorÂ² platform.
  Please submit bugs at https://github.com/jalibu/MMM-RNV/issues

  (c) Julian Dinter,Jan Litzenburger
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */
"use strict";var e=require("node_helper"),t=require("apollo-client"),n=require("apollo-cache-inmemory"),r=require("apollo-link-http"),o=require("apollo-link-context"),i=require("graphql-tag"),s=require("node-fetch"),a=require("logger");function l(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var c=l(e),u=l(a);module.exports=c.create({start(){this.client=null,this.schedule=[],this.colorCodes=[],this.failedRequests=0,this.getColorCodes()},async getColorCodes(){try{const e=await s("https://rnvopendataportalpublic.blob.core.windows.net/public/openDataPortal/liniengruppen-farben.json"),t=await e.json();this.colorCodes=t.lineGroups}catch(e){const t=e instanceof Error?e.message:String(e);u.warn(`Could not request color codes: ${t}`)}},async socketNotificationReceived(e,t){if("RNV_DEPARTURE_REQUEST"===e){const e=t;this.getData(e)}},async getData(e){try{if(!this.client)try{this.client=await this.createClient(e)}catch(e){const t=e instanceof Error?e.message:String(e);return u.error(`Error generating the client: ${t}`),void this.sendSocketNotification("RNV_ERROR_RESPONSE",{type:"WARNING",message:"Error with API authentication."})}const t=new Date(Date.now()+e.walkingTimeMs);u.info(`Request departures for station '${e.stationId}'`);const n=`query {\n            station(id:"${e.stationId}") {\n                hafasID\n                longName\n                journeys(startTime: "${t.toISOString()}" first: 50) {\n                    totalCount\n                    elements {\n                        ... on Journey {\n                            line {\n                                id\n                            }\n                            type\n                            stops(onlyHafasID: "${e.stationId}") {\n                                pole {\n                                    platform {\n                                        type\n                                        label\n                                        barrierFreeType\n                                    }\n                                }\n                                destinationLabel\n                                plannedArrival {\n                                    isoString\n                                }\n                                realtimeArrival {\n                                    isoString\n                                }\n                                plannedDeparture {\n                                    isoString\n                                }\n                                realtimeDeparture {\n                                    isoString\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }`,r=[],o=(await this.client.query({query:i(n)})).data.station.journeys.elements.filter(e=>null!==e.stops[0].plannedDeparture.isoString);o.sort((e,t)=>{const n=e.stops[0].plannedDeparture.isoString,r=t.stops[0].plannedDeparture.isoString;return n<r?-1:n>r?1:0});for(const t of o){const n=new Date(t.stops[0].plannedDeparture.isoString);let o=0;try{const e=new Date(t.stops[0].realtimeDeparture.isoString).getTime()-n.getTime();o=Math.round(e/6e4)}catch(e){const t=e instanceof Error?e.message:String(e);u.warn(`Error calculating the delay: ${t}`)}const i=t.line.id.split("-")[1];if(e.excludeLines.includes(i)||e.excludePlatforms.includes(t.stops[0].pole.platform.label))continue;const s={line:i,destination:t.stops[0].destinationLabel,departure:n.getTime(),delayInMin:o,platform:t.stops[0].pole.platform.label,type:t.type,highlighted:e.highlightLines.includes(i),color:this.colorCodes.find(e=>e.id===i)};if(r.push(s),r.length===e.maxResults)break}this.failedRequests=0,this.sendSocketNotification(`RNV_DATA_RESPONSE_${e.stationId}`,r)}catch(e){const t=e instanceof Error?e.message:String(e);u.warn(`Error fetching the data from the API: ${t}`),this.failedRequests+=1,this.failedRequests>5&&(this.client=null,u.log("Reset the RNV API client"),this.sendSocketNotification("RNV_ERROR_RESPONSE",{type:"WARNING",message:"Error fetching data."}))}},async createClient(e){const{clientId:i,clientSecret:a,resourceId:l,tenantId:c}=e.credentials,d=await s(`https://login.microsoftonline.com/${c}/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`grant_type=client_credentials&client_id=${i}&client_secret=${a}&resource=${l}`});if(!d.ok)throw Error(`Could not fetch the access token (${d.status} ${d.statusText})`);const{access_token:p}=await d.json();u.log("Created new RNV API access token");const h=r.createHttpLink({uri:e.clientApiUrl,fetch:s}),g=o.setContext(async(e,{headers:t})=>({headers:{...t,authorization:p?`Bearer ${p}`:null}}));return new t.ApolloClient({link:g.concat(h),cache:new n.InMemoryCache})}});
